---
title: "Contact Quotient analysis"
author: "Stefano Coretta and Massimiliano Canzi"
date: "13/01/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../"))
library(tidyverse)
theme_set(theme_minimal())
library(mgcv)
library(itsadug)
options(contrasts = rep("contr.treatment", 2))
```

# Read data

```{r read-data}
words <- read_csv("./stimuli/words.csv")

cq <- read_csv("./results/tracegram.csv") %>%
    mutate(
        cq = minimum - maximum,
        position = ordered(position, levels = c("medial", "final"))
    ) %>%
    left_join(y = words) %>%
    mutate(
        freq_bin = ifelse(
            log_frequency < 4.465,
            "low",
            "high"
        ),
        vowel = as.ordered(vowel),
        consonant_2 = ordered(consonant_2, levels = c("k", "t"))
    ) %>%
    mutate_if(is.character, as.factor) %>%
    filter(cq > 0)
```

# Exploration

```{r}
cq %>%
    ggplot(aes(proportion, cq, colour = position)) +
    geom_point(alpha = 0.2) +
    geom_smooth()
```

```{r}
cq %>%
    ggplot(aes(proportion, cq, colour = position)) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    facet_wrap(~ consonant_2)
```

```{r}
cq %>%
    ggplot(aes(proportion, cq, colour = freq_bin)) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    facet_grid(position ~ consonant_2)
```

```{r}
cq %>%
    ggplot(aes(freq_bin, cq)) +
    geom_boxplot() +
    facet_grid(position ~ consonant_2)
```

```{r}
cq_gam <- bam(
    cq ~
        s(proportion, by = position) +
        ti(proportion, log_frequency),
    data = cq,
    method = "ML"
)

summary(cq_gam)
```

```{r}
plot_smooth(
    cq_gam,
    "proportion",
    plot_all = "position",
    rug = FALSE
)
```

```{r}
fvisgam(
    cq_gam,
    view = c("proportion", "log_frequency"),
    cond = list(position = "medial")
)
fvisgam(
    cq_gam,
    view = c("proportion", "log_frequency"),
    cond = list(position = "final")
)
```

```{r}
cq_gam_2 <- bam(
    cq ~
        position +
        vowel +
        consonant_2 +
        s(proportion) +
        s(proportion, by = position) +
        s(proportion, by = vowel) +
        s(proportion, by = consonant_2) +
        s(proportion, by = interaction(consonant_2, position)) +
        ti(proportion, log_frequency) +
        s(proportion, word, bs = "fs"),
    data = cq,
    method = "fREML"
)

summary(cq_gam_2)
```

```{r}
fvisgam(
    cq_gam_2,
    view = c("proportion", "log_frequency"),
    cond = list(position = "medial"),
    rm.ranef = TRUE
)
fvisgam(
    cq_gam_2,
    view = c("proportion", "log_frequency"),
    cond = list(position = "final"),
    rm.ranef = TRUE
)
```
